name: CD - Deploy to Environments

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod

env:
  JAVA_VERSION: '17'
  APP_PORT: 7000

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    outputs:
      artifact-path: ${{ steps.build.outputs.artifact-path }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: ðŸ”§ Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: ./crud
      
    - name: ðŸ“¦ Build application
      id: build
      run: |
        echo "::group::ðŸ”¨ Building application"
        ./gradlew clean build --no-daemon
        echo "::endgroup::"
      working-directory: ./crud
      
    - name: ðŸ“¤ Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: application-jar
        path: crud/build/libs/*.jar
        retention-days: 7

  deploy-dev:
    name: Deploy to Development
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: development
      url: http://localhost:${{ env.APP_PORT }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: application-jar
        path: ./artifacts
        
    - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ðŸš€ Start application (Dev)
      run: |
        echo "::group::ðŸš€ Starting application in development mode"
        java -jar artifacts/*.jar &
        echo $! > app.pid
        sleep 10
        echo "::endgroup::"
        
    - name: âœ… Health check
      run: |
        echo "::group::âœ… Performing health check"
        for i in {1..30}; do
          if curl -f http://localhost:${{ env.APP_PORT }}/api/produtos > /dev/null 2>&1; then
            echo "âœ… Application is healthy"
            exit 0
          fi
          echo "â³ Waiting for application to start... ($i/30)"
          sleep 2
        done
        echo "âŒ Application failed to start"
        exit 1
        echo "::endgroup::"
        
    - name: ðŸ§ª Run post-deploy tests
      run: |
        echo "::group::ðŸ§ª Running post-deploy tests"
        cd crud
        chmod +x gradlew
        ./gradlew test --tests "*PostDeployTest" -Dapp.url=http://localhost:${{ env.APP_PORT }} --no-daemon || true
        echo "::endgroup::"
      continue-on-error: true
      
    - name: ðŸ›‘ Stop application
      if: always()
      run: |
        if [ -f app.pid ]; then
          kill $(cat app.pid) || true
          rm app.pid
        fi

  deploy-test:
    name: Deploy to Test
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: test
      url: http://localhost:${{ env.APP_PORT }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: application-jar
        path: ./artifacts
        
    - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ðŸš€ Start application (Test)
      run: |
        echo "::group::ðŸš€ Starting application in test mode"
        java -jar artifacts/*.jar &
        echo $! > app.pid
        sleep 10
        echo "::endgroup::"
        
    - name: âœ… Health check
      run: |
        echo "::group::âœ… Performing health check"
        for i in {1..30}; do
          if curl -f http://localhost:${{ env.APP_PORT }}/api/produtos > /dev/null 2>&1; then
            echo "âœ… Application is healthy"
            exit 0
          fi
          echo "â³ Waiting for application to start... ($i/30)"
          sleep 2
        done
        echo "âŒ Application failed to start"
        exit 1
        echo "::endgroup::"
        
    - name: ðŸ§ª Run comprehensive post-deploy tests
      run: |
        echo "::group::ðŸ§ª Running comprehensive post-deploy tests"
        cd crud
        chmod +x gradlew
        ./gradlew test --tests "*PostDeployTest" -Dapp.url=http://localhost:${{ env.APP_PORT }} --no-daemon
        echo "::endgroup::"
        
    - name: ðŸ›‘ Stop application
      if: always()
      run: |
        if [ -f app.pid ]; then
          kill $(cat app.pid) || true
          rm app.pid
        fi

  deploy-prod:
    name: Deploy to Production
    needs: [build, deploy-test]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://localhost:${{ env.APP_PORT }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: application-jar
        path: ./artifacts
        
    - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ðŸš€ Start application (Production)
      run: |
        echo "::group::ðŸš€ Starting application in production mode"
        java -jar artifacts/*.jar &
        echo $! > app.pid
        sleep 10
        echo "::endgroup::"
        
    - name: âœ… Health check
      run: |
        echo "::group::âœ… Performing production health check"
        for i in {1..30}; do
          if curl -f http://localhost:${{ env.APP_PORT }}/api/produtos > /dev/null 2>&1; then
            echo "âœ… Application is healthy"
            exit 0
          fi
          echo "â³ Waiting for application to start... ($i/30)"
          sleep 2
        done
        echo "âŒ Application failed to start"
        exit 1
        echo "::endgroup::"
        
    - name: ðŸ§ª Run production smoke tests
      run: |
        echo "::group::ðŸ§ª Running production smoke tests"
        cd crud
        chmod +x gradlew
        ./gradlew test --tests "*PostDeployTest" -Dapp.url=http://localhost:${{ env.APP_PORT }} --no-daemon
        echo "::endgroup::"
        
    - name: ðŸ“ Deployment summary
      if: always()
      run: |
        echo "::group::ðŸ“ Deployment Summary"
        echo "### ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŒ Environment | Production |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”— URL | http://localhost:${{ env.APP_PORT }} |" >> $GITHUB_STEP_SUMMARY
        echo "| âœ… Status | Deployed Successfully |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "::endgroup::"
        
    - name: ðŸ›‘ Stop application
      if: always()
      run: |
        if [ -f app.pid ]; then
          kill $(cat app.pid) || true
          rm app.pid
        fi

