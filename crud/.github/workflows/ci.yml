name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.jvmargs=-Xmx2048m'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: ðŸ”§ Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: ./crud
      
    - name: ðŸ“¦ Build with Gradle
      id: build
      run: |
        echo "::group::ðŸ”¨ Building project"
        ./gradlew build --no-daemon --stacktrace
        echo "::endgroup::"
      working-directory: ./crud
      
    - name: ðŸ§ª Run tests
      id: test
      run: |
        echo "::group::ðŸ§ª Running tests"
        ./gradlew test --no-daemon --stacktrace
        echo "::endgroup::"
      working-directory: ./crud
      continue-on-error: false
      
    - name: ðŸ“Š Generate coverage report
      id: coverage
      run: |
        echo "::group::ðŸ“Š Generating coverage report"
        ./gradlew jacocoTestReport --no-daemon
        echo "::endgroup::"
      working-directory: ./crud
      
    - name: âœ… Verify coverage threshold
      id: coverage-check
      run: |
        echo "::group::âœ… Verifying coverage threshold (90%)"
        ./gradlew jacocoTestCoverageVerification --no-daemon || true
        echo "::endgroup::"
      working-directory: ./crud
      continue-on-error: true
      
    - name: ðŸ“¤ Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: |
          crud/build/reports/jacoco/test/html/**
          crud/build/reports/jacoco/test/jacocoTestReport.xml
        retention-days: 30
        
    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: crud/build/test-results/**
        retention-days: 30
        
    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: build-artifacts
        path: crud/build/libs/**
        retention-days: 7
        
    - name: ðŸ“ Generate test summary
      if: always()
      run: |
        echo "::group::ðŸ“ Test Summary"
        if [ -f crud/build/test-results/test/TEST-*.xml ]; then
          echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          TOTAL=$(find crud/build/test-results/test -name "TEST-*.xml" -exec grep -o 'tests="[0-9]*"' {} \; | awk -F'"' '{sum+=$2} END {print sum}')
          FAILED=$(find crud/build/test-results/test -name "TEST-*.xml" -exec grep -o 'failures="[0-9]*"' {} \; | awk -F'"' '{sum+=$2} END {print sum}')
          ERRORS=$(find crud/build/test-results/test -name "TEST-*.xml" -exec grep -o 'errors="[0-9]*"' {} \; | awk -F'"' '{sum+=$2} END {print sum}')
          SKIPPED=$(find crud/build/test-results/test -name "TEST-*.xml" -exec grep -o 'skipped="[0-9]*"' {} \; | awk -F'"' '{sum+=$2} END {print sum}')
          
          PASSED=$((TOTAL - FAILED - ERRORS - SKIPPED))
          
          echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        echo "::endgroup::"
        
    - name: ðŸ“Š Generate coverage summary
      if: always()
      run: |
        echo "::group::ðŸ“Š Coverage Summary"
        if [ -f crud/build/reports/jacoco/test/jacocoTestReport.xml ]; then
          echo "### ðŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract coverage from XML (simplified)
          INSTRUCTION_COVERAGE=$(grep -o 'type="INSTRUCTION".*missed="[0-9]*".*covered="[0-9]*"' crud/build/reports/jacoco/test/jacocoTestReport.xml | head -1 | grep -o 'missed="[0-9]*"' | awk -F'"' '{missed=$2} END {getline; covered=$2; total=missed+covered; if(total>0) printf "%.2f", (covered*100)/total; else print "0.00"}')
          
          echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ Instructions | ${INSTRUCTION_COVERAGE:-N/A}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Full report available in artifacts." >> $GITHUB_STEP_SUMMARY
        fi
        echo "::endgroup::"
        
    - name: ðŸŽ¯ Job Summary
      if: always()
      run: |
        echo "::notice::CI Pipeline completed"
        if [ "${{ steps.test.outcome }}" != "success" ]; then
          echo "::error::Tests failed!"
          exit 1
        fi
        if [ "${{ steps.coverage-check.outcome }}" != "success" ]; then
          echo "::warning::Coverage threshold may not be met"
        fi
