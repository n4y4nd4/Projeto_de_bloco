name: CD - Coverage and Quality Check

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'

jobs:
  coverage-check:
    name: Coverage and Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: ðŸ”§ Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: ./crud
      
    - name: ðŸ§ª Run tests with coverage
      run: |
        echo "::group::ðŸ§ª Running tests with coverage"
        ./gradlew test jacocoTestReport jacocoTestCoverageVerification --no-daemon --stacktrace
        echo "::endgroup::"
      working-directory: ./crud
      
    - name: ðŸ“Š Generate coverage report
      run: |
        echo "::group::ðŸ“Š Generating coverage report"
        ./gradlew jacocoTestReport --no-daemon
        echo "::endgroup::"
      working-directory: ./crud
      
    - name: ðŸ“¤ Upload coverage to artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: crud/build/reports/jacoco/test/html/**
        retention-days: 30
        
    - name: ðŸ“ Generate coverage summary
      if: always()
      run: |
        echo "::group::ðŸ“ Coverage Summary"
        echo "### ðŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f crud/build/reports/jacoco/test/jacocoTestReport.xml ]; then
          echo "âœ… Coverage report generated successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Full HTML report available in artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage Threshold:** 90% (Instructions)" >> $GITHUB_STEP_SUMMARY
          echo "**Branch Coverage:** 85% (Branches)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Coverage report not found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "::endgroup::"
