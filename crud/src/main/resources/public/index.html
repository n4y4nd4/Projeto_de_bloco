<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>CRUD de Produtos - Listagem</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Produtos Cadastrados</h1>
        <a href="/add.html" class="btn btn-success" id="add-btn">Adicionar Novo Produto</a>
        
        <div id="alert-message" class="alert" style="display:none;"></div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Preço</th>
                    <th>Estoque</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="product-list">
                </tbody>
        </table>
    </div>

    <script>
        const tableBody = document.getElementById('product-list');
        const alertDiv = document.getElementById('alert-message');
        
        // Função para extrair mensagem da URL (após redirecionamento)
        function checkUrlForMessage() {
            const urlParams = new URLSearchParams(window.location.search);
            const msg = urlParams.get('msg');
            const type = urlParams.get('type') || 'success';

            if (msg) {
                alertDiv.textContent = decodeURIComponent(msg);
                alertDiv.className = 'alert alert-' + type;
                alertDiv.style.display = 'block';
                // Limpa a URL para que a mensagem não reapareça ao recarregar
                history.replaceState(null, null, window.location.pathname);
            }
        }

        async function fetchProducts() {
            const response = await fetch('/api/produtos');
            const products = await response.json();
            
            tableBody.innerHTML = '';
            
            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">Nenhum produto cadastrado.</td></tr>';
                return;
            }

            products.forEach(p => {
                const row = tableBody.insertRow();
                row.id = 'product-' + p.id;
                
                row.insertCell().textContent = p.id;
                row.insertCell().textContent = p.nome;
                row.insertCell().textContent = p.preco.toFixed(2);
                row.insertCell().textContent = p.estoque;
                
                const actions = row.insertCell();
                
                const editLink = document.createElement('a');
                editLink.href = `/edit.html?id=${p.id}`;
                editLink.className = 'btn btn-warning';
                editLink.textContent = 'Editar';
                editLink.id = 'edit-btn-' + p.id;
                actions.appendChild(editLink);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger delete-btn';
                deleteBtn.textContent = 'Excluir';
                deleteBtn.id = 'delete-btn-' + p.id;
                deleteBtn.onclick = () => deleteProduct(p.id);
                actions.appendChild(deleteBtn);
            });
        }

        async function deleteProduct(id) {
            if (confirm('Tem certeza que deseja excluir o produto ' + id + '?')) {
                const response = await fetch(`/api/produtos/${id}`, { method: 'DELETE' });
                const result = await response.json();

                if (response.ok) {
                    window.location.href = `/index.html?msg=${encodeURIComponent('Produto ' + id + ' excluído com sucesso.')}&type=success`;
                } else {
                    alert('Erro ao excluir: ' + result.message);
                }
            }
        }

        checkUrlForMessage();
        fetchProducts();
    </script>
</body>
</html>