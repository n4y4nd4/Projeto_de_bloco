<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Editar Produto</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Editar Produto <span id="produto-id-display"></span></h1>
        <p id="teste-nayanda" style="color:red; font-size:22px;">TESTE NAYANDA 999</p>

        <a href="/index.html" class="btn btn-primary">Voltar para Listagem</a>
        
        <div id="alert-message" class="alert alert-danger" style="display:none;"></div>

        <form id="edit-form" style="display:none;">
            <input type="hidden" id="id" name="id">

            <label for="nome">Nome:</label>
            <input type="text" id="nome" name="nome" required>

            <label for="preco">Preço:</label>
            <input type="number" id="preco" name="preco" step="0.01" min="0.01" required>

            <label for="estoque">Estoque:</label>
            <input type="number" id="estoque" name="estoque" min="0" required>

            <button type="submit" class="btn btn-success" id="update-btn">Salvar Alterações</button>
        </form>
        <p id="not-found-msg" style="color: red;"></p>
    </div>

    <script>
        const form = document.getElementById('edit-form');
        const alertDiv = document.getElementById('alert-message');
        const idInput = document.getElementById('id');
        const notFoundMsg = document.getElementById('not-found-msg');
        const produtoIdDisplay = document.getElementById('produto-id-display');

        async function loadProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            if (!id) {
                notFoundMsg.textContent = 'ID do produto não especificado.';
                return;
            }

            produtoIdDisplay.textContent = '(ID: ' + id + ')';

            const response = await fetch(`/api/produtos/${id}`);

            if (response.ok) {
                const p = await response.json();
                idInput.value = p.id;
                document.getElementById('nome').value = p.nome;
                document.getElementById('preco').value = p.preco;
                document.getElementById('estoque').value = p.estoque;
                form.style.display = 'block';
            } else {
                const result = await response.json();
                notFoundMsg.textContent = result.message || 'Produto não encontrado.';
                form.style.display = 'none';
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                alertDiv.style.display = 'none';

                const id = idInput.value;
                const produto = {
                    nome: document.getElementById('nome').value,
                    preco: parseFloat(document.getElementById('preco').value),
                    estoque: parseInt(document.getElementById('estoque').value, 10)
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(`/api/produtos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(produto),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    alertDiv.textContent = "Erro inesperado: resposta inválida do servidor.";
                    alertDiv.style.display = 'block';
                    console.error("Erro ao parsear resposta:", parseError);
                    return;
                }

                if (response.ok) {
                    window.location.href = `/index.html?msg=${encodeURIComponent('Produto ' + id + ' atualizado com sucesso.')}&type=success`;
                } else {
                    alertDiv.textContent = result.message || 'Erro desconhecido ao atualizar.';
                    alertDiv.style.display = 'block';
                }

            } catch (err) {
                if (err.name === 'AbortError') {
                    alertDiv.textContent = "A requisição demorou muito para responder. Por favor, tente novamente.";
                    alertDiv.style.display = 'block';
                } else if (err instanceof TypeError && err.message.includes('fetch')) {
                    alertDiv.textContent = "Erro de conexão. Verifique sua internet e tente novamente.";
                    alertDiv.style.display = 'block';
                } else {
                    alertDiv.textContent = "Ocorreu um erro inesperado. Por favor, tente novamente mais tarde.";
                    alertDiv.style.display = 'block';
                }
                console.error("Erro ao atualizar produto:", err);
            }
        });

        loadProduct();
    </script>
</body>
</html>
