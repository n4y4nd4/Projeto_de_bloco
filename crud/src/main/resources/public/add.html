<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Adicionar Produto</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <h1>Adicionar Novo Produto</h1>
    <a href="/index.html" class="btn btn-primary">Voltar para Listagem</a>

    <!-- ALERTA -->
    <div id="alert-message" class="alert alert-danger" style="display:none; visibility:hidden;"></div>

    <form id="add-form">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" name="nome">

        <label for="preco">Preço:</label>
        <input type="number" id="preco" name="preco" step="0.01">

        <label for="estoque">Estoque:</label>
        <input type="number" id="estoque" name="estoque">

        <button type="submit" class="btn btn-success" id="save-btn">Salvar Produto</button>
    </form>
</div>

<script>
    const form = document.getElementById('add-form');
    const alertDiv = document.getElementById('alert-message');

    function showAlert(message) {
        if (message && message.trim() !== '') {
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            alertDiv.style.visibility = 'visible';
            // Força o navegador a renderizar
            alertDiv.offsetHeight;
            console.log('[DEBUG] Alerta exibido:', message);
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        alertDiv.style.display = 'none';
        alertDiv.style.visibility = 'hidden';
        alertDiv.textContent = "";

        const nome = document.getElementById('nome').value.trim();
        const precoValue = document.getElementById('preco').value;
        const estoqueValue = document.getElementById('estoque').value;
        
    
        let preco = null;
        if (precoValue !== '') {
            const parsed = parseFloat(precoValue);
            preco = isNaN(parsed) ? null : parsed;
        }
        
        let estoque = null;
        if (estoqueValue !== '') {
            const parsed = parseInt(estoqueValue, 10);
            estoque = isNaN(parsed) ? null : parsed;
        }

        const produto = { nome, preco, estoque };

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);

            const response = await fetch('/api/produtos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(produto),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            let result;
            try {
                result = await response.json();
            } catch (parseError) {
                showAlert("Erro inesperado: resposta inválida do servidor.");
                console.error("Erro ao parsear resposta:", parseError);
                return;
            }

            if (response.ok) {
                window.location.href =
                    `/index.html?msg=${encodeURIComponent('Produto "' + result.nome + '" adicionado com sucesso.')}&type=success`;
            } else {
                const errorMessage = result.message || 'Erro desconhecido ao cadastrar.';
                console.log('[DEBUG] Erro do servidor:', errorMessage);
                showAlert(errorMessage);
            }

        } catch (err) {
            if (err.name === 'AbortError') {
                console.error("Timeout na requisição:", err);
                showAlert("A requisição demorou muito para responder. Por favor, tente novamente.");
            } else if (err instanceof TypeError && err.message.includes('fetch')) {
                console.error("Erro de rede:", err);
                showAlert("Erro de conexão. Verifique sua internet e tente novamente.");
            } else {
                console.error("Erro inesperado:", err);
                showAlert("Ocorreu um erro inesperado. Por favor, tente novamente mais tarde.");
            }
        }
    });
</script>
</body>
</html>
